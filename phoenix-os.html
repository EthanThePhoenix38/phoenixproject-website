<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>PhoenixOS v2.1.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;overflow:hidden;height:100vh;touch-action:manipulation}

/* BOOT SCREEN */
#bootScreen{position:fixed;inset:0;background:#000;color:#0f0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;font-family:monospace}
#bootScreen.hidden{display:none}
.boot-logo{font-size:80px;margin-bottom:30px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.boot-text{font-size:14px;margin:5px 0}

/* LOGIN SCREEN */
#loginScreen{position:fixed;inset:0;background:linear-gradient(135deg,#667eea,#764ba2);display:none;align-items:center;justify-content:center;z-index:99998}
#loginScreen.show{display:flex}
.login-box{background:rgba(255,255,255,0.95);padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center;min-width:320px}
.login-logo{font-size:60px;margin-bottom:20px}
.login-input{width:100%;padding:15px;margin:10px 0;border:2px solid #ddd;border-radius:10px;font-size:16px}
.login-btn{width:100%;padding:15px;background:#007AFF;color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-top:10px}
.login-btn:hover{background:#0051D5}

/* SHUTDOWN SCREEN */
#shutdownScreen{position:fixed;inset:0;background:#000;color:#fff;display:none;align-items:center;justify-content:center;z-index:99997;flex-direction:column}
#shutdownScreen.show{display:flex}
.shutdown-icon{font-size:100px;margin-bottom:30px;animation:fadeOut 2s forwards}
@keyframes fadeOut{to{opacity:0}}

/* DESKTOP */
#desktop{height:100%;display:flex;flex-direction:column;background:linear-gradient(135deg,#667eea,#764ba2);background-size:cover;position:relative;display:none}
#desktop.show{display:flex}
.desktop-area{flex:1;position:relative;overflow:hidden;padding-bottom:70px}
.desktop-icons{position:absolute;top:20px;left:20px;display:grid;grid-template-columns:repeat(auto-fill,90px);gap:15px;max-width:calc(100% - 40px)}
.desktop-icon{width:80px;text-align:center;cursor:pointer;padding:8px;border-radius:8px;transition:background 0.2s}
.desktop-icon:hover,.desktop-icon:active{background:rgba(255,255,255,0.2)}
.desktop-icon-img{font-size:40px;margin-bottom:5px;pointer-events:none}
.desktop-icon-label{color:#fff;font-size:11px;text-shadow:0 1px 3px rgba(0,0,0,0.5);pointer-events:none}

/* MENUBAR */
.menubar{height:32px;background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);display:flex;align-items:center;padding:0 10px;gap:10px;font-size:13px;border-bottom:1px solid rgba(0,0,0,0.1);z-index:9999}
.menubar-left{display:flex;gap:10px;align-items:center}
.menubar-item{cursor:pointer;padding:6px 10px;border-radius:4px;transition:background 0.2s;white-space:nowrap}
.menubar-item:hover{background:rgba(0,0,0,0.05)}
.menubar-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.menu-dropdown{position:absolute;top:32px;left:10px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);padding:5px;min-width:180px;display:none;z-index:10000;max-height:80vh;overflow-y:auto}
.menu-dropdown.show{display:block}
.menu-item{padding:8px 12px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;font-size:13px}
.menu-item:hover{background:#f0f0f0}
.menu-separator{height:1px;background:#ddd;margin:3px 0}

/* WINDOWS */
.window{position:absolute;background:#fff;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.3);display:none;flex-direction:column;min-width:300px;min-height:200px;z-index:100;max-width:95vw;max-height:90vh}
.window.show{display:flex}
.window.maximized{top:32px!important;left:0!important;width:100%!important;height:calc(100vh - 32px - 70px)!important;border-radius:0!important;max-width:100vw!important;max-height:100vh!important}
.window-header{background:linear-gradient(180deg,#f8f8f8,#e8e8e8);padding:10px 12px;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center;cursor:move;border-radius:10px 10px 0 0;touch-action:none}
.window.maximized .window-header{border-radius:0;cursor:default}
.window-title{font-weight:600;flex:1;text-align:center;font-size:13px}
.window-controls{display:flex;gap:6px;position:absolute;left:12px}
.window-btn{width:12px;height:12px;border-radius:50%;cursor:pointer;border:1px solid rgba(0,0,0,0.15);transition:all 0.2s}
.window-btn:hover{border-color:rgba(0,0,0,0.3)}
.window-btn.close{background:#FF5F57}
.window-btn.minimize{background:#FEBC2E}
.window-btn.maximize{background:#28C840}
.window-body{flex:1;overflow:auto;background:#fff;-webkit-overflow-scrolling:touch}
.window-resize{position:absolute;bottom:0;right:0;width:30px;height:30px;cursor:nwse-resize;z-index:10;touch-action:none}
.window-resize::after{content:'';position:absolute;bottom:2px;right:2px;width:0;height:0;border-style:solid;border-width:0 0 12px 12px;border-color:transparent transparent #999 transparent}

/* TASKBAR */
.taskbar{position:fixed;bottom:0;left:0;right:0;height:60px;background:rgba(255,255,255,0.3);backdrop-filter:blur(30px);border-top:1px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;gap:8px;padding:0 10px;z-index:9998;overflow-x:auto}
.taskbar-item{width:48px;height:48px;background:rgba(255,255,255,0.9);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;transition:transform 0.2s;flex-shrink:0}
.taskbar-item:active{transform:scale(0.95)}

/* ON-SCREEN KEYBOARD */
#osk{position:fixed;bottom:0;left:0;right:0;background:#d1d5db;padding:8px;display:none;z-index:10001;box-shadow:0 -2px 10px rgba(0,0,0,0.2)}
#osk.show{display:block}
.osk-row{display:flex;gap:4px;margin-bottom:4px;justify-content:center}
.osk-key{background:#fff;border:1px solid #9ca3af;border-radius:4px;padding:12px;min-width:32px;text-align:center;cursor:pointer;user-select:none;font-size:14px;font-weight:500}
.osk-key:active{background:#e5e7eb}
.osk-key.wide{flex:2}
.osk-key.space{flex:5}

/* NOTIFICATIONS */
.notification{position:fixed;top:45px;right:15px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.3);padding:12px 16px;min-width:250px;max-width:350px;z-index:10000;animation:slideIn 0.3s}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
.notification strong{display:block;margin-bottom:5px}

/* CONTEXT MENU */
.context-menu{position:fixed;background:#fff;border-radius:6px;box-shadow:0 4px 15px rgba(0,0,0,0.2);padding:4px;min-width:150px;z-index:10000;display:none}
.context-menu.show{display:block}
.context-item{padding:6px 10px;cursor:pointer;border-radius:4px;font-size:12px;display:flex;align-items:center;gap:6px}
.context-item:hover{background:#f0f0f0}

/* BUTTONS */
.btn{padding:10px 16px;background:#007AFF;color:#fff;border:none;border-radius:8px;cursor:pointer;margin:4px;font-size:14px;font-weight:500;transition:all 0.2s;touch-action:manipulation}
.btn:active{transform:scale(0.98)}
.btn-secondary{background:#6c757d}
.btn-danger{background:#dc3545}
.btn-success{background:#28a745}

/* INPUTS */
input,textarea,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;margin:6px 0;font-size:14px;font-family:inherit;touch-action:manipulation}
input:focus,textarea:focus,select:focus{outline:none;border-color:#007AFF;box-shadow:0 0 0 3px rgba(0,122,255,0.1)}

/* FILE BROWSER */
.file-list{list-style:none;padding:10px}
.file-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background 0.2s}
.file-item:active{background:#f8f9fa}
.file-item-icon{font-size:32px;flex-shrink:0}
.file-item-info{flex:1;min-width:0}
.file-item-name{font-weight:500;font-size:14px;word-break:break-word}
.file-item-meta{font-size:11px;color:#666;margin-top:2px}
.file-item-actions{display:flex;gap:4px;flex-shrink:0}
.breadcrumb{padding:12px 15px;background:#f8f8f8;border-bottom:1px solid #ddd;font-size:13px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.breadcrumb-item{cursor:pointer;color:#007AFF}
.breadcrumb-item:hover{text-decoration:underline}
.breadcrumb-separator{color:#999}

/* TERMINAL */
.terminal{background:#1e1e1e;color:#0f0;font-family:'Courier New',monospace;padding:12px;height:100%;overflow-y:auto;font-size:13px}
.terminal-line{margin:3px 0;line-height:1.4;word-break:break-all}
.terminal-input{background:transparent;border:none;color:#0f0;font-family:inherit;font-size:inherit;width:calc(100% - 20px);outline:none}

/* CALCULATOR */
.calculator-display{background:#2d2d2d;color:#fff;padding:20px 15px;font-size:36px;text-align:right;border-radius:6px;margin-bottom:15px;min-height:80px;display:flex;align-items:center;justify-content:flex-end;word-break:break-all}
.calculator-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:15px}
.calc-btn{padding:20px;border:none;border-radius:10px;font-size:20px;font-weight:600;cursor:pointer;transition:all 0.15s;background:#f0f0f0;color:#000;touch-action:manipulation}
.calc-btn:active{transform:scale(0.95)}
.calc-btn.operator{background:#ff9500;color:#fff}
.calc-btn.equals{background:#34c759;color:#fff}
.calc-btn.clear{background:#ff3b30;color:#fff}

/* MOBILE RESPONSIVE */
@media (max-width:768px){
  .window{min-width:90vw!important;width:90vw!important}
  .window.maximized{width:100vw!important;height:calc(100vh - 32px - 60px - 180px)!important}
  #osk.show ~ #desktop .window.maximized{height:calc(100vh - 32px - 60px - 180px)!important}
  .desktop-icons{grid-template-columns:repeat(auto-fill,75px);gap:10px}
  .desktop-icon{width:70px}
  .desktop-icon-img{font-size:36px}
  .taskbar{height:55px;gap:6px}
  .taskbar-item{width:44px;height:44px;font-size:22px}
  .menubar{font-size:12px;padding:0 8px;gap:6px}
  .menubar-item{padding:5px 8px}
  .calculator-display{font-size:28px;padding:15px 12px;min-height:70px}
  .calc-btn{padding:16px;font-size:18px}
}

@media (max-width:480px){
  .desktop-icons{grid-template-columns:repeat(auto-fill,65px);gap:8px}
  .desktop-icon{width:60px}
  .desktop-icon-img{font-size:32px}
  .desktop-icon-label{font-size:10px}
  .window-title{font-size:12px}
  .calculator-display{font-size:24px}
  .calc-btn{padding:14px;font-size:16px}
}
</style>
</head>
<body>

<!-- BOOT SCREEN -->
<div id="bootScreen">
  <div class="boot-logo">üî•</div>
  <div class="boot-text">PhoenixOS v2.1.0</div>
  <div class="boot-text">Initializing system...</div>
  <div class="boot-text" id="bootProgress">Loading...</div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">üî•</div>
    <h2 style="margin-bottom:20px">PhoenixOS</h2>
    <input type="password" id="loginPassword" class="login-input" placeholder="Enter password" autocomplete="off">
    <button class="login-btn" onclick="attemptLogin()">Login</button>
    <p style="margin-top:15px;font-size:12px;color:#666">Default: phoenix</p>
  </div>
</div>

<!-- SHUTDOWN SCREEN -->
<div id="shutdownScreen">
  <div class="shutdown-icon">üî•</div>
  <div style="font-size:24px">Shutting down...</div>
</div>

<!-- DESKTOP -->
<div id="desktop">
  <div class="menubar">
    <div class="menubar-left">
      <div class="menubar-item" style="font-weight:700;font-size:14px" onclick="toggleStartMenu()">üî•</div>
      <div class="menubar-item" onclick="toggleStartMenu()">Apps</div>
    </div>
    <div class="menubar-right">
      <div class="menubar-item">üîî</div>
      <div class="menubar-item">üì∂</div>
      <div class="menubar-item">üîã</div>
      <div class="menubar-item" id="clock">00:00</div>
      <div class="menubar-item" onclick="openSettings()">‚öôÔ∏è</div>
    </div>
  </div>

  <div class="menu-dropdown" id="startMenu">
    <div class="menu-item" onclick="openFiles();closeStartMenu()"><span>üìÅ</span> Files</div>
    <div class="menu-item" onclick="openEditor();closeStartMenu()"><span>üìù</span> Editor</div>
    <div class="menu-item" onclick="openTerminal();closeStartMenu()"><span>‚å®Ô∏è</span> Terminal</div>
    <div class="menu-item" onclick="openCalculator();closeStartMenu()"><span>üî¢</span> Calculator</div>
    <div class="menu-item" onclick="openBrowser();closeStartMenu()"><span>üåê</span> Browser</div>
    <div class="menu-item" onclick="openPaint();closeStartMenu()"><span>üé®</span> Paint</div>
    <div class="menu-item" onclick="openGames();closeStartMenu()"><span>üéÆ</span> Games</div>
    <div class="menu-separator"></div>
    <div class="menu-item" onclick="openSettings();closeStartMenu()"><span>‚öôÔ∏è</span> Settings</div>
    <div class="menu-item" onclick="shutdown()"><span>‚èª</span> Shutdown</div>
  </div>

  <div class="desktop-area" id="desktopArea">
    <div class="desktop-icons">
      <div class="desktop-icon" ondblclick="openFiles()">
        <div class="desktop-icon-img">üìÅ</div>
        <div class="desktop-icon-label">Files</div>
      </div>
      <div class="desktop-icon" ondblclick="openTerminal()">
        <div class="desktop-icon-img">‚å®Ô∏è</div>
        <div class="desktop-icon-label">Terminal</div>
      </div>
      <div class="desktop-icon" ondblclick="openCalculator()">
        <div class="desktop-icon-img">üî¢</div>
        <div class="desktop-icon-label">Calculator</div>
      </div>
      <div class="desktop-icon" ondblclick="openBrowser()">
        <div class="desktop-icon-img">üåê</div>
        <div class="desktop-icon-label">Browser</div>
      </div>
      <div class="desktop-icon" ondblclick="openPaint()">
        <div class="desktop-icon-img">üé®</div>
        <div class="desktop-icon-label">Paint</div>
      </div>
      <div class="desktop-icon" ondblclick="openGames()">
        <div class="desktop-icon-img">üéÆ</div>
        <div class="desktop-icon-label">Games</div>
      </div>
    </div>
  </div>

  <div class="taskbar">
    <div class="taskbar-item" onclick="openFiles()">üìÅ</div>
    <div class="taskbar-item" onclick="openTerminal()">‚å®Ô∏è</div>
    <div class="taskbar-item" onclick="openCalculator()">üî¢</div>
    <div class="taskbar-item" onclick="openBrowser()">üåê</div>
    <div class="taskbar-item" onclick="openPaint()">üé®</div>
    <div class="taskbar-item" onclick="openGames()">üéÆ</div>
  </div>
</div>

<!-- ON-SCREEN KEYBOARD -->
<div id="osk">
  <div class="osk-row">
    <div class="osk-key" onclick="oskType('1')">1</div>
    <div class="osk-key" onclick="oskType('2')">2</div>
    <div class="osk-key" onclick="oskType('3')">3</div>
    <div class="osk-key" onclick="oskType('4')">4</div>
    <div class="osk-key" onclick="oskType('5')">5</div>
    <div class="osk-key" onclick="oskType('6')">6</div>
    <div class="osk-key" onclick="oskType('7')">7</div>
    <div class="osk-key" onclick="oskType('8')">8</div>
    <div class="osk-key" onclick="oskType('9')">9</div>
    <div class="osk-key" onclick="oskType('0')">0</div>
  </div>
  <div class="osk-row">
    <div class="osk-key" onclick="oskType('q')">q</div>
    <div class="osk-key" onclick="oskType('w')">w</div>
    <div class="osk-key" onclick="oskType('e')">e</div>
    <div class="osk-key" onclick="oskType('r')">r</div>
    <div class="osk-key" onclick="oskType('t')">t</div>
    <div class="osk-key" onclick="oskType('y')">y</div>
    <div class="osk-key" onclick="oskType('u')">u</div>
    <div class="osk-key" onclick="oskType('i')">i</div>
    <div class="osk-key" onclick="oskType('o')">o</div>
    <div class="osk-key" onclick="oskType('p')">p</div>
  </div>
  <div class="osk-row">
    <div class="osk-key" onclick="oskType('a')">a</div>
    <div class="osk-key" onclick="oskType('s')">s</div>
    <div class="osk-key" onclick="oskType('d')">d</div>
    <div class="osk-key" onclick="oskType('f')">f</div>
    <div class="osk-key" onclick="oskType('g')">g</div>
    <div class="osk-key" onclick="oskType('h')">h</div>
    <div class="osk-key" onclick="oskType('j')">j</div>
    <div class="osk-key" onclick="oskType('k')">k</div>
    <div class="osk-key" onclick="oskType('l')">l</div>
  </div>
  <div class="osk-row">
    <div class="osk-key wide" onclick="oskShift()">‚áß</div>
    <div class="osk-key" onclick="oskType('z')">z</div>
    <div class="osk-key" onclick="oskType('x')">x</div>
    <div class="osk-key" onclick="oskType('c')">c</div>
    <div class="osk-key" onclick="oskType('v')">v</div>
    <div class="osk-key" onclick="oskType('b')">b</div>
    <div class="osk-key" onclick="oskType('n')">n</div>
    <div class="osk-key" onclick="oskType('m')">m</div>
    <div class="osk-key wide" onclick="oskBackspace()">‚å´</div>
  </div>
  <div class="osk-row">
    <div class="osk-key" onclick="oskType('.')">.</div>
    <div class="osk-key space" onclick="oskType(' ')">space</div>
    <div class="osk-key wide" onclick="oskEnter()">‚Üµ</div>
    <div class="osk-key" onclick="toggleOSK()">‚úï</div>
  </div>
</div>

<div class="context-menu" id="contextMenu">
  <div class="context-item" onclick="hideContextMenu()"><span>‚úï</span> Close</div>
</div>

<script>
// FILE SYSTEM with folders
const FS = {
  getData() {
    const data = localStorage.getItem('phoenixos_fs');
    return data ? JSON.parse(data) : {'/': {type: 'folder', items: {}}};
  },
  saveData(data) {
    localStorage.setItem('phoenixos_fs', JSON.stringify(data));
  },
  getPath(path) {
    const parts = path.split('/').filter(p => p);
    let current = this.getData();
    for (const part of parts) {
      if (!current[part] || current[part].type !== 'folder') return null;
      current = current[part].items;
    }
    return current;
  },
  mkdir(path, name) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items) return false;
    if (parent.items[name]) return false;
    parent.items[name] = {type: 'folder', items: {}, date: new Date().toISOString()};
    this.saveData(data);
    return true;
  },
  createFile(path, name, content = '') {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items) return false;
    parent.items[name] = {type: 'file', content, date: new Date().toISOString()};
    this.saveData(data);
    return true;
  },
  delete(path, name) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items || !parent.items[name]) return false;
    delete parent.items[name];
    this.saveData(data);
    return true;
  },
  read(path, name) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items || !parent.items[name]) return null;
    return parent.items[name].type === 'file' ? parent.items[name].content : null;
  },
  update(path, name, content) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items || !parent.items[name] || parent.items[name].type !== 'file') return false;
    parent.items[name].content = content;
    parent.items[name].date = new Date().toISOString();
    this.saveData(data);
    return true;
  },
  list(path = '/') {
    const data = this.getData();
    const folder = this.getPathObj(data, path);
    if (!folder || !folder.items) return [];
    return Object.entries(folder.items).map(([name, item]) => ({
      name,
      type: item.type,
      date: item.date,
      size: item.type === 'file' ? (item.content?.length || 0) : null
    }));
  },
  getPathObj(data, path) {
    if (path === '/') return data['/'];
    const parts = path.split('/').filter(p => p);
    let current = data['/'];
    for (const part of parts) {
      if (!current.items || !current.items[part]) return null;
      current = current.items[part];
    }
    return current;
  }
};

// Initialize default structure
if (!localStorage.getItem('phoenixos_fs')) {
  FS.mkdir('/', 'Documents');
  FS.mkdir('/', 'Downloads');
  FS.createFile('/Documents', 'welcome.txt', 'Welcome to PhoenixOS!');
}

let currentPath = '/';

// BOOT SEQUENCE
window.onload = function() {
  const bootTexts = [
    'Loading kernel...',
    'Mounting file system...',
    'Starting services...',
    'Ready!'
  ];

  let i = 0;
  const bootInterval = setInterval(() => {
    if (i < bootTexts.length) {
      document.getElementById('bootProgress').textContent = bootTexts[i];
      i++;
    } else {
      clearInterval(bootInterval);
      setTimeout(() => {
        document.getElementById('bootScreen').classList.add('hidden');
        document.getElementById('loginScreen').classList.add('show');
      }, 500);
    }
  }, 600);
};

// LOGIN
function attemptLogin() {
  const pwd = document.getElementById('loginPassword').value;
  if (pwd === 'phoenix' || pwd === '') {
    document.getElementById('loginScreen').classList.remove('show');
    document.getElementById('desktop').classList.add('show');
    showNotification('Welcome', 'PhoenixOS v2.1.0');
    updateClock();
  } else {
    showNotification('Error', 'Incorrect password');
    document.getElementById('loginPassword').value = '';
  }
}

document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') attemptLogin();
});

// SHUTDOWN
function shutdown() {
  closeStartMenu();
  document.getElementById('desktop').classList.remove('show');
  document.getElementById('shutdownScreen').classList.add('show');
  setTimeout(() => {
    document.getElementById('shutdownScreen').classList.remove('show');
    document.getElementById('loginScreen').classList.add('show');
  }, 3000);
}

// WINDOW MANAGER
let zIndex = 100;
let activeWindow = null;
let isMobile = window.innerWidth <= 768;

window.addEventListener('resize', () => {
  isMobile = window.innerWidth <= 768;
});

function createWindow(title, content, width = 600, height = 400) {
  const win = document.createElement('div');
  win.className = 'window show';

  if (isMobile) {
    win.style.width = '90vw';
    win.style.height = '70vh';
    win.style.top = '60px';
    win.style.left = '5vw';
  } else {
    win.style.width = Math.min(width, window.innerWidth - 100) + 'px';
    win.style.height = Math.min(height, window.innerHeight - 150) + 'px';
    win.style.top = (60 + Math.random() * 50) + 'px';
    win.style.left = (50 + Math.random() * 100) + 'px';
  }

  win.style.zIndex = ++zIndex;
  win.innerHTML = `
    <div class="window-header">
      <div class="window-controls">
        <div class="window-btn close"></div>
        <div class="window-btn minimize"></div>
        <div class="window-btn maximize"></div>
      </div>
      <div class="window-title">${title}</div>
    </div>
    <div class="window-body">${content}</div>
    <div class="window-resize"></div>
  `;

  win.querySelector('.close').onclick = () => win.remove();
  win.querySelector('.minimize').onclick = () => {
    win.style.display = 'none';
    setTimeout(() => win.style.display = 'flex', 100);
  };
  win.querySelector('.maximize').onclick = () => {
    win.classList.toggle('maximized');
  };

  // Focus management
  win.addEventListener('mousedown', () => {
    if (activeWindow && activeWindow !== win) {
      activeWindow.style.opacity = '0.95';
    }
    activeWindow = win;
    win.style.zIndex = ++zIndex;
    win.style.opacity = '1';
  });
  win.addEventListener('touchstart', () => {
    if (activeWindow && activeWindow !== win) {
      activeWindow.style.opacity = '0.95';
    }
    activeWindow = win;
    win.style.zIndex = ++zIndex;
    win.style.opacity = '1';
  });

  // Draggable (desktop only)
  if (!isMobile) {
    const header = win.querySelector('.window-header');
    let isDragging = false, startX, startY, startLeft, startTop;

    header.addEventListener('mousedown', e => {
      if (win.classList.contains('maximized')) return;
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      startLeft = win.offsetLeft;
      startTop = win.offsetTop;
    });

    document.addEventListener('mousemove', e => {
      if (!isDragging || win.classList.contains('maximized')) return;
      win.style.left = (startLeft + e.clientX - startX) + 'px';
      win.style.top = (startTop + e.clientY - startY) + 'px';
    });

    document.addEventListener('mouseup', () => isDragging = false);

    // Resizable
    const resizeHandle = win.querySelector('.window-resize');
    let isResizing = false;

    resizeHandle.addEventListener('mousedown', e => {
      if (win.classList.contains('maximized')) return;
      isResizing = true;
      startX = e.clientX;
      startY = e.clientY;
      startLeft = win.offsetWidth;
      startTop = win.offsetHeight;
      e.stopPropagation();
    });

    document.addEventListener('mousemove', e => {
      if (!isResizing) return;
      const newWidth = startLeft + (e.clientX - startX);
      const newHeight = startTop + (e.clientY - startY);
      if (newWidth > 300) win.style.width = newWidth + 'px';
      if (newHeight > 200) win.style.height = newHeight + 'px';
    });

    document.addEventListener('mouseup', () => isResizing = false);
  }

  // Touch drag for mobile
  if (isMobile) {
    const header = win.querySelector('.window-header');
    let touchStartX, touchStartY, touchStartLeft, touchStartTop;

    header.addEventListener('touchstart', e => {
      if (win.classList.contains('maximized')) return;
      const touch = e.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      touchStartLeft = win.offsetLeft;
      touchStartTop = win.offsetTop;
    });

    header.addEventListener('touchmove', e => {
      if (win.classList.contains('maximized')) return;
      e.preventDefault();
      const touch = e.touches[0];
      win.style.left = (touchStartLeft + touch.clientX - touchStartX) + 'px';
      win.style.top = (touchStartTop + touch.clientY - touchStartY) + 'px';
    });
  }

  document.getElementById('desktopArea').appendChild(win);
  return win.querySelector('.window-body');
}

// START MENU
function toggleStartMenu() {
  document.getElementById('startMenu').classList.toggle('show');
}

function closeStartMenu() {
  document.getElementById('startMenu').classList.remove('show');
}

document.addEventListener('click', (e) => {
  const menu = document.getElementById('startMenu');
  if (!menu.contains(e.target) && !e.target.closest('.menubar-item')) {
    closeStartMenu();
  }
});

// NOTIFICATIONS
function showNotification(title, message) {
  const notif = document.createElement('div');
  notif.className = 'notification';
  notif.innerHTML = `<strong>${title}</strong><div>${message}</div>`;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

// CONTEXT MENU
function hideContextMenu() {
  document.getElementById('contextMenu').classList.remove('show');
}

document.getElementById('desktopArea').addEventListener('contextmenu', (e) => {
  e.preventDefault();
  const menu = document.getElementById('contextMenu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('show');
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.context-menu')) hideContextMenu();
});

// ON-SCREEN KEYBOARD
let oskTarget = null;
let oskShiftActive = false;

function showOSK(target) {
  oskTarget = target;
  document.getElementById('osk').classList.add('show');
}

function toggleOSK() {
  document.getElementById('osk').classList.toggle('show');
  oskTarget = null;
}

function oskType(char) {
  if (!oskTarget) {
    oskTarget = document.activeElement;
  }
  if (oskTarget && (oskTarget.tagName === 'INPUT' || oskTarget.tagName === 'TEXTAREA')) {
    const start = oskTarget.selectionStart;
    const end = oskTarget.selectionEnd;
    const text = oskTarget.value;
    const finalChar = oskShiftActive ? char.toUpperCase() : char;
    oskTarget.value = text.substring(0, start) + finalChar + text.substring(end);
    oskTarget.selectionStart = oskTarget.selectionEnd = start + 1;
    oskShiftActive = false;
  }
}

function oskBackspace() {
  if (oskTarget && (oskTarget.tagName === 'INPUT' || oskTarget.tagName === 'TEXTAREA')) {
    const start = oskTarget.selectionStart;
    const end = oskTarget.selectionEnd;
    const text = oskTarget.value;
    if (start > 0 && start === end) {
      oskTarget.value = text.substring(0, start - 1) + text.substring(end);
      oskTarget.selectionStart = oskTarget.selectionEnd = start - 1;
    } else if (start !== end) {
      oskTarget.value = text.substring(0, start) + text.substring(end);
      oskTarget.selectionStart = oskTarget.selectionEnd = start;
    }
  }
}

function oskEnter() {
  if (oskTarget) {
    const event = new KeyboardEvent('keypress', {key: 'Enter', keyCode: 13});
    oskTarget.dispatchEvent(event);
  }
}

function oskShift() {
  oskShiftActive = !oskShiftActive;
}

// Auto-show OSK on mobile
if (isMobile) {
  document.addEventListener('focusin', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      setTimeout(() => showOSK(e.target), 100);
    }
  });
}

// FILES APP
function openFiles() {
  const body = createWindow('Files', '', 700, 500);
  body.style.padding = '0';
  renderFileList(body, currentPath);
}

function renderFileList(container, path) {
  const items = FS.list(path);
  const pathParts = path.split('/').filter(p => p);

  let html = '<div class="breadcrumb">';
  html += '<span class="breadcrumb-item" onclick="navigateToPath(\'/\')">üè†</span>';
  let buildPath = '';
  pathParts.forEach((part, i) => {
    buildPath += '/' + part;
    const thisPath = buildPath;
    html += '<span class="breadcrumb-separator">/</span>';
    html += `<span class="breadcrumb-item" onclick="navigateToPath('${thisPath}')">${part}</span>`;
  });
  html += '</div>';

  html += '<div style="padding:12px;background:#f8f8f8;border-bottom:1px solid #ddd;display:flex;gap:8px;flex-wrap:wrap">';
  html += '<button class="btn" style="padding:8px 12px;margin:0;font-size:13px" onclick="createNewFolder()">+ Folder</button>';
  html += '<button class="btn" style="padding:8px 12px;margin:0;font-size:13px" onclick="createNewFile()">+ File</button>';
  if (path !== '/') {
    html += '<button class="btn btn-secondary" style="padding:8px 12px;margin:0;font-size:13px" onclick="navigateUp()">‚Üë Up</button>';
  }
  html += '</div>';

  html += '<ul class="file-list">';

  items.forEach(item => {
    const icon = item.type === 'folder' ? 'üìÅ' : 'üìÑ';
    const size = item.type === 'file' ? `${item.size} bytes` : 'Folder';
    const date = new Date(item.date).toLocaleDateString();

    html += `
      <li class="file-item" ${item.type === 'folder' ? `ondblclick="openFolder('${item.name}')"` : ''}>
        <div class="file-item-icon">${icon}</div>
        <div class="file-item-info">
          <div class="file-item-name">${item.name}</div>
          <div class="file-item-meta">${size} ‚Ä¢ ${date}</div>
        </div>
        <div class="file-item-actions">
          ${item.type === 'file' ? `<button class="btn" style="padding:6px 10px;margin:0;font-size:12px" onclick="openFileInEditor('${item.name}')">Open</button>` : ''}
          <button class="btn btn-danger" style="padding:6px 10px;margin:0;font-size:12px" onclick="deleteItem('${item.name}')">Del</button>
        </div>
      </li>
    `;
  });

  if (items.length === 0) {
    html += '<div style="text-align:center;padding:40px;color:#999">Empty folder</div>';
  }

  html += '</ul>';
  container.innerHTML = html;
}

window.navigateToPath = function(path) {
  currentPath = path;
  const fileWindows = document.querySelectorAll('.window');
  fileWindows.forEach(win => {
    if (win.querySelector('.window-title')?.textContent === 'Files') {
      renderFileList(win.querySelector('.window-body'), currentPath);
    }
  });
};

window.navigateUp = function() {
  const parts = currentPath.split('/').filter(p => p);
  parts.pop();
  currentPath = parts.length ? '/' + parts.join('/') : '/';
  navigateToPath(currentPath);
};

window.openFolder = function(name) {
  currentPath = currentPath === '/' ? '/' + name : currentPath + '/' + name;
  navigateToPath(currentPath);
};

window.createNewFolder = function() {
  const name = prompt('Folder name:');
  if (name && name.trim()) {
    if (FS.mkdir(currentPath, name.trim())) {
      showNotification('Success', `Folder "${name}" created`);
      navigateToPath(currentPath);
    } else {
      showNotification('Error', 'Could not create folder');
    }
  }
};

window.createNewFile = function() {
  const name = prompt('File name:');
  if (name && name.trim()) {
    if (FS.createFile(currentPath, name.trim(), '')) {
      showNotification('Success', `File "${name}" created`);
      navigateToPath(currentPath);
    } else {
      showNotification('Error', 'Could not create file');
    }
  }
};

window.deleteItem = function(name) {
  if (confirm(`Delete "${name}"?`)) {
    if (FS.delete(currentPath, name)) {
      showNotification('Deleted', `"${name}" removed`);
      navigateToPath(currentPath);
    }
  }
};

window.openFileInEditor = function(name) {
  const content = FS.read(currentPath, name);
  if (content !== null) {
    openEditorWithFile(name, content);
  }
};

// TEXT EDITOR
function openEditor() {
  openEditorWithFile('', '');
}

function openEditorWithFile(filename, content) {
  const body = createWindow('Editor', '', 700, 500);
  body.style.padding = '0';
  const uniqueId = Date.now();
  body.innerHTML = `
    <div style="padding:12px;background:#f8f8f8;border-bottom:1px solid #ddd">
      <input type="text" id="editorName${uniqueId}" placeholder="Filename" value="${filename}" style="margin:0">
    </div>
    <textarea id="editorText${uniqueId}" style="height:calc(100% - 110px);border:none;border-radius:0;margin:0;resize:none;font-family:monospace;font-size:13px;padding:15px" onfocus="showOSK(this)">${content}</textarea>
    <div style="padding:12px;background:#f8f8f8;border-top:1px solid #ddd">
      <button class="btn btn-success" style="padding:8px 16px;margin:0" onclick="saveFile(${uniqueId})">üíæ Save</button>
    </div>
  `;
}

window.saveFile = function(id) {
  const nameInput = document.getElementById('editorName' + id);
  const textArea = document.getElementById('editorText' + id);
  const name = nameInput.value.trim();
  const content = textArea.value;

  if (!name) {
    showNotification('Error', 'Enter filename');
    return;
  }

  const existing = FS.list(currentPath).find(f => f.name === name);
  if (existing && existing.type === 'file') {
    FS.update(currentPath, name, content);
  } else {
    FS.createFile(currentPath, name, content);
  }

  showNotification('Saved', `File "${name}" saved`);
};

// TERMINAL
function openTerminal() {
  const body = createWindow('Terminal', '', 700, 400);
  body.style.padding = '0';
  const uniqueId = Date.now();
  body.innerHTML = `
    <div class="terminal" id="termOutput${uniqueId}">
      <div class="terminal-line">PhoenixOS Terminal v2.1.0</div>
      <div class="terminal-line">Type 'help' for commands</div>
      <div class="terminal-line" style="margin-top:8px">$ <input type="text" class="terminal-input" id="termInput${uniqueId}" autocomplete="off" onfocus="showOSK(this)"></div>
    </div>
  `;

  const input = document.getElementById('termInput' + uniqueId);
  const output = document.getElementById('termOutput' + uniqueId);

  input.focus();
  input.addEventListener('keypress', (e) => {
    if (e.key !== 'Enter') return;
    const cmd = input.value.trim();

    const line = document.createElement('div');
    line.className = 'terminal-line';
    line.textContent = '$ ' + cmd;
    output.insertBefore(line, output.lastElementChild);

    if (cmd) executeTerminalCommand(cmd, output);

    input.value = '';
    output.scrollTop = output.scrollHeight;
  });
}

window.termCurrentPath = '/';

function executeTerminalCommand(cmd, output) {
  const parts = cmd.split(' ');
  let response = '';

  switch(parts[0]) {
    case 'help':
      response = 'Commands: help, clear, ls, pwd, cd, mkdir, cat, rm, echo, date, whoami';
      break;
    case 'clear':
      output.innerHTML = '<div class="terminal-line">$ <input type="text" class="terminal-input" autocomplete="off"></div>';
      output.querySelector('.terminal-input').focus();
      return;
    case 'ls':
      const items = FS.list(window.termCurrentPath || '/');
      response = items.length ? items.map(f => (f.type === 'folder' ? 'üìÅ ' : 'üìÑ ') + f.name).join('\n') : 'Empty';
      break;
    case 'pwd':
      response = window.termCurrentPath || '/';
      break;
    case 'cd':
      if (!parts[1]) {
        window.termCurrentPath = '/';
        response = 'Changed to /';
      } else if (parts[1] === '..') {
        const p = (window.termCurrentPath || '/').split('/').filter(x => x);
        p.pop();
        window.termCurrentPath = p.length ? '/' + p.join('/') : '/';
        response = 'Changed to ' + window.termCurrentPath;
      } else {
        const items = FS.list(window.termCurrentPath || '/');
        const folder = items.find(f => f.name === parts[1] && f.type === 'folder');
        if (folder) {
          window.termCurrentPath = (window.termCurrentPath === '/' ? '' : window.termCurrentPath) + '/' + parts[1];
          response = 'Changed to ' + window.termCurrentPath;
        } else {
          response = 'Folder not found';
        }
      }
      break;
    case 'mkdir':
      if (parts[1]) {
        if (FS.mkdir(window.termCurrentPath || '/', parts[1])) {
          response = `Created folder: ${parts[1]}`;
        } else {
          response = 'Error creating folder';
        }
      } else {
        response = 'Usage: mkdir <name>';
      }
      break;
    case 'cat':
      if (parts[1]) {
        const content = FS.read(window.termCurrentPath || '/', parts[1]);
        response = content !== null ? content : 'File not found';
      } else {
        response = 'Usage: cat <filename>';
      }
      break;
    case 'rm':
      if (parts[1]) {
        if (FS.delete(window.termCurrentPath || '/', parts[1])) {
          response = `Deleted: ${parts[1]}`;
        } else {
          response = 'Error deleting';
        }
      } else {
        response = 'Usage: rm <name>';
      }
      break;
    case 'echo':
      response = parts.slice(1).join(' ');
      break;
    case 'date':
      response = new Date().toString();
      break;
    case 'whoami':
      response = 'phoenix-user';
      break;
    default:
      response = `Command not found: ${parts[0]}`;
  }

  const respLine = document.createElement('div');
  respLine.className = 'terminal-line';
  respLine.style.whiteSpace = 'pre-wrap';
  respLine.textContent = response;
  output.insertBefore(respLine, output.lastElementChild);
}

// CALCULATOR
function openCalculator() {
  const body = createWindow('Calculator', '', 350, 500);
  body.style.padding = '15px';

  body.innerHTML = `
    <div class="calculator-display" id="calcDisplay${Date.now()}">0</div>
    <div class="calculator-buttons">
      <button class="calc-btn clear" onclick="calcClear(this)">AC</button>
      <button class="calc-btn" onclick="calcDel(this)">‚å´</button>
      <button class="calc-btn operator" onclick="calcOp(this, '%')">%</button>
      <button class="calc-btn operator" onclick="calcOp(this, '/')">√∑</button>
      <button class="calc-btn" onclick="calcNum(this, '7')">7</button>
      <button class="calc-btn" onclick="calcNum(this, '8')">8</button>
      <button class="calc-btn" onclick="calcNum(this, '9')">9</button>
      <button class="calc-btn operator" onclick="calcOp(this, '*')">√ó</button>
      <button class="calc-btn" onclick="calcNum(this, '4')">4</button>
      <button class="calc-btn" onclick="calcNum(this, '5')">5</button>
      <button class="calc-btn" onclick="calcNum(this, '6')">6</button>
      <button class="calc-btn operator" onclick="calcOp(this, '-')">‚àí</button>
      <button class="calc-btn" onclick="calcNum(this, '1')">1</button>
      <button class="calc-btn" onclick="calcNum(this, '2')">2</button>
      <button class="calc-btn" onclick="calcNum(this, '3')">3</button>
      <button class="calc-btn operator" onclick="calcOp(this, '+')">+</button>
      <button class="calc-btn" onclick="calcNum(this, '0')" style="grid-column:span 2">0</button>
      <button class="calc-btn" onclick="calcNum(this, '.')">.</button>
      <button class="calc-btn equals" onclick="calcEq(this)">=</button>
    </div>
  `;
}

window.calcClear = function(btn) {
  const win = btn.closest('.window-body');
  const display = win.querySelector('[id^="calcDisplay"]');
  win.dataset.value = '0';
  win.dataset.operator = '';
  win.dataset.prev = '0';
  win.dataset.waiting = 'false';
  display.textContent = '0';
};

window.calcNum = function(btn, num) {
  const win = btn.closest('.window-body');
  const display = win.querySelector('[id^="calcDisplay"]');
  let val = win.dataset.value || '0';
  const waiting = win.dataset.waiting === 'true';

  if (waiting) {
    val = num;
    win.dataset.waiting = 'false';
  } else {
    if (num === '.' && val.includes('.')) return;
    val = val === '0' && num !== '.' ? num : val + num;
  }

  win.dataset.value = val;
  display.textContent = val;
};

window.calcOp = function(btn, op) {
  const win = btn.closest('.window-body');
  const display = win.querySelector('[id^="calcDisplay"]');
  const val = parseFloat(win.dataset.value || '0');
  const prevOp = win.dataset.operator;
  const prev = parseFloat(win.dataset.prev || '0');

  if (prevOp && win.dataset.waiting !== 'true') {
    const result = calcExec(prev, val, prevOp);
    win.dataset.value = String(result);
    win.dataset.prev = String(result);
    display.textContent = result;
  } else {
    win.dataset.prev = String(val);
  }

  win.dataset.operator = op;
  win.dataset.waiting = 'true';
};

window.calcEq = function(btn) {
  const win = btn.closest('.window-body');
  const display = win.querySelector('[id^="calcDisplay"]');
  const val = parseFloat(win.dataset.value || '0');
  const op = win.dataset.operator;
  const prev = parseFloat(win.dataset.prev || '0');

  if (op) {
    const result = calcExec(prev, val, op);
    win.dataset.value = String(result);
    win.dataset.operator = '';
    win.dataset.prev = '0';
    win.dataset.waiting = 'true';
    display.textContent = result;
  }
};

window.calcDel = function(btn) {
  const win = btn.closest('.window-body');
  const display = win.querySelector('[id^="calcDisplay"]');
  let val = win.dataset.value || '0';
  val = val.length > 1 ? val.slice(0, -1) : '0';
  win.dataset.value = val;
  display.textContent = val;
};

function calcExec(a, b, op) {
  switch(op) {
    case '+': return a + b;
    case '-': return a - b;
    case '*': return a * b;
    case '/': return b !== 0 ? a / b : 0;
    case '%': return a % b;
    default: return b;
  }
}

// BROWSER
function openBrowser() {
  const body = createWindow('Browser', '', 800, 600);
  body.style.padding = '0';
  const uniqueId = Date.now();
  body.innerHTML = `
    <div style="display:flex;gap:8px;padding:12px;background:#f8f8f8;border-bottom:1px solid #ddd">
      <input type="text" id="browserUrl${uniqueId}" placeholder="Enter URL..." value="https://example.com" style="flex:1;margin:0" onfocus="showOSK(this)">
      <button class="btn btn-success" style="padding:8px 16px;margin:0" onclick="browserGo(${uniqueId})">Go</button>
    </div>
    <iframe id="browserFrame${uniqueId}" style="width:100%;height:calc(100% - 60px);border:none" sandbox="allow-same-origin allow-scripts"></iframe>
  `;
}

window.browserGo = function(id) {
  const input = document.getElementById('browserUrl' + id);
  const frame = document.getElementById('browserFrame' + id);
  let url = input.value.trim();
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'https://' + url;
  }
  frame.src = url;
};

// PAINT
function openPaint() {
  const body = createWindow('Paint', '', 700, 550);
  body.style.padding = '0';
  const uniqueId = Date.now();
  body.innerHTML = `
    <div style="display:flex;gap:6px;padding:10px;background:#f8f8f8;border-bottom:1px solid #ddd;flex-wrap:wrap">
      <button class="btn" style="padding:6px 12px;margin:0;font-size:12px" onclick="setPaintTool(${uniqueId}, 'brush')">üñåÔ∏è</button>
      <button class="btn" style="padding:6px 12px;margin:0;font-size:12px" onclick="setPaintTool(${uniqueId}, 'eraser')">üßπ</button>
      <button class="btn btn-danger" style="padding:6px 12px;margin:0;font-size:12px" onclick="clearPaint(${uniqueId})">Clear</button>
      <div style="flex:1"></div>
      ${['#000', '#f00', '#0f0', '#00f', '#ff0'].map(c =>
        `<div style="width:30px;height:30px;background:${c};border:2px solid #ddd;border-radius:4px;cursor:pointer" onclick="setPaintColor(${uniqueId}, '${c}')"></div>`
      ).join('')}
    </div>
    <canvas id="paintCanvas${uniqueId}" width="700" height="480" style="display:block;cursor:crosshair;background:#fff;touch-action:none"></canvas>
  `;

  const canvas = document.getElementById('paintCanvas' + uniqueId);
  const ctx = canvas.getContext('2d');
  let painting = false;
  canvas.dataset.color = '#000';
  canvas.dataset.tool = 'brush';

  // Mouse
  canvas.addEventListener('mousedown', () => painting = true);
  canvas.addEventListener('mouseup', () => painting = false);
  canvas.addEventListener('mouseleave', () => painting = false);
  canvas.addEventListener('mousemove', (e) => {
    if (!painting) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx.lineWidth = canvas.dataset.tool === 'eraser' ? 20 : 3;
    ctx.lineCap = 'round';
    ctx.strokeStyle = canvas.dataset.tool === 'eraser' ? '#fff' : canvas.dataset.color;
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  });

  // Touch
  canvas.addEventListener('touchstart', (e) => {
    painting = true;
    e.preventDefault();
  });
  canvas.addEventListener('touchend', () => painting = false);
  canvas.addEventListener('touchmove', (e) => {
    if (!painting) return;
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    ctx.lineWidth = canvas.dataset.tool === 'eraser' ? 20 : 3;
    ctx.lineCap = 'round';
    ctx.strokeStyle = canvas.dataset.tool === 'eraser' ? '#fff' : canvas.dataset.color;
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  });
}

window.setPaintColor = function(id, color) {
  const canvas = document.getElementById('paintCanvas' + id);
  canvas.dataset.color = color;
};

window.setPaintTool = function(id, tool) {
  const canvas = document.getElementById('paintCanvas' + id);
  canvas.dataset.tool = tool;
};

window.clearPaint = function(id) {
  if (confirm('Clear canvas?')) {
    const canvas = document.getElementById('paintCanvas' + id);
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
};

// SETTINGS
function openSettings() {
  closeStartMenu();
  const body = createWindow('Settings', '', 500, 400);
  body.innerHTML = `
    <div style="padding:20px">
      <h3 style="margin-bottom:15px">System Info</h3>
      <p><strong>OS:</strong> PhoenixOS v2.1.0</p>
      <p><strong>Platform:</strong> ${navigator.platform}</p>
      <p><strong>Storage:</strong> ${(JSON.stringify(localStorage).length / 1024).toFixed(2)} KB</p>
      <hr style="margin:20px 0">
      <button class="btn btn-danger" onclick="if(confirm('Clear all data?')){localStorage.clear();location.reload()}">Clear Data</button>
      <button class="btn" onclick="shutdown()">Shutdown</button>
    </div>
  `;
}

// GAMES
function openGames() {
  const body = createWindow('Games', '', 400, 350);
  body.innerHTML = `
    <div style="padding:20px">
      <h2 style="margin-bottom:15px;text-align:center">üéÆ Games</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <button class="btn" style="padding:25px;font-size:16px" onclick="playSnake()">üêç Snake</button>
        <button class="btn" style="padding:25px;font-size:16px" onclick="playPong()">üèì Pong</button>
        <button class="btn" style="padding:25px;font-size:16px" onclick="playTicTacToe()">‚≠ï Tic-Tac-Toe</button>
        <button class="btn" style="padding:25px;font-size:16px" onclick="playMemory()">üÉè Memory</button>
      </div>
    </div>
  `;
}

function playSnake() {
  const body = createWindow('Snake', '', 420, 520);
  const uniqueId = Date.now();
  body.innerHTML = `
    <div style="text-align:center;padding:15px">
      <div id="snakeScore${uniqueId}" style="font-size:20px;font-weight:600;margin-bottom:12px">Score: 0</div>
      <canvas id="snakeCanvas${uniqueId}" width="400" height="400" style="border:2px solid #ddd;background:#000;border-radius:6px"></canvas>
      <div style="margin-top:12px;color:#666;font-size:13px">Arrow keys or swipe</div>
    </div>
  `;

  const canvas = document.getElementById('snakeCanvas' + uniqueId);
  const ctx = canvas.getContext('2d');
  const grid = 20;
  let snake = [{x: 10, y: 10}];
  let dir = {x: 1, y: 0};
  let food = {x: 15, y: 15};
  let score = 0;

  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowUp' && dir.y === 0) dir = {x: 0, y: -1};
    if (e.key === 'ArrowDown' && dir.y === 0) dir = {x: 0, y: 1};
    if (e.key === 'ArrowLeft' && dir.x === 0) dir = {x: -1, y: 0};
    if (e.key === 'ArrowRight' && dir.x === 0) dir = {x: 1, y: 0};
  });

  // Touch controls
  let touchStartX, touchStartY;
  canvas.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  });
  canvas.addEventListener('touchend', e => {
    if (!touchStartX || !touchStartY) return;
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    const dx = touchEndX - touchStartX;
    const dy = touchEndY - touchStartY;
    if (Math.abs(dx) > Math.abs(dy)) {
      if (dx > 0 && dir.x === 0) dir = {x: 1, y: 0};
      if (dx < 0 && dir.x === 0) dir = {x: -1, y: 0};
    } else {
      if (dy > 0 && dir.y === 0) dir = {x: 0, y: 1};
      if (dy < 0 && dir.y === 0) dir = {x: 0, y: -1};
    }
  });

  const gameLoop = setInterval(() => {
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

    if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20 ||
        snake.some(s => s.x === head.x && s.y === head.y)) {
      clearInterval(gameLoop);
      showNotification('Game Over', `Score: ${score}`);
      return;
    }

    snake.unshift(head);

    if (head.x === food.x && head.y === food.y) {
      score++;
      document.getElementById('snakeScore' + uniqueId).textContent = 'Score: ' + score;
      food = {x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20)};
    } else {
      snake.pop();
    }

    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, 400, 400);
    ctx.fillStyle = '#0f0';
    snake.forEach(s => ctx.fillRect(s.x * grid, s.y * grid, grid - 2, grid - 2));
    ctx.fillStyle = '#f00';
    ctx.fillRect(food.x * grid, food.y * grid, grid - 2, grid - 2);
  }, 150);
}

function playPong() {
  const body = createWindow('Pong', '', 420, 520);
  const uniqueId = Date.now();
  body.innerHTML = `
    <div style="text-align:center;padding:15px">
      <div id="pongScore${uniqueId}" style="font-size:20px;font-weight:600;margin-bottom:12px">0 - 0</div>
      <canvas id="pongCanvas${uniqueId}" width="400" height="400" style="border:2px solid #ddd;background:#000;border-radius:6px;touch-action:none"></canvas>
      <div style="margin-top:12px;color:#666;font-size:13px">Touch/mouse to control</div>
    </div>
  `;

  const canvas = document.getElementById('pongCanvas' + uniqueId);
  const ctx = canvas.getContext('2d');
  let ball = {x: 200, y: 200, dx: 3, dy: 3};
  let p1 = {y: 160, score: 0};
  let p2 = {y: 160, score: 0};

  canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    p1.y = e.clientY - rect.top - 40;
  });

  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    p1.y = e.touches[0].clientY - rect.top - 40;
  });

  const gameLoop = setInterval(() => {
    ball.x += ball.dx;
    ball.y += ball.dy;

    if (ball.y < 0 || ball.y > 390) ball.dy *= -1;
    if (ball.x < 20 && ball.y > p1.y && ball.y < p1.y + 80) ball.dx *= -1;
    if (ball.x > 370 && ball.y > p2.y && ball.y < p2.y + 80) ball.dx *= -1;

    if (ball.x < 0) {
      p2.score++;
      ball = {x: 200, y: 200, dx: 3, dy: 3};
      document.getElementById('pongScore' + uniqueId).textContent = p1.score + ' - ' + p2.score;
    }
    if (ball.x > 400) {
      p1.score++;
      ball = {x: 200, y: 200, dx: -3, dy: 3};
      document.getElementById('pongScore' + uniqueId).textContent = p1.score + ' - ' + p2.score;
    }

    p2.y += (ball.y - p2.y - 40) * 0.1;

    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, 400, 400);
    ctx.fillStyle = '#fff';
    ctx.fillRect(10, p1.y, 10, 80);
    ctx.fillRect(380, p2.y, 10, 80);
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, 5, 0, Math.PI * 2);
    ctx.fill();
  }, 1000/60);
}

function playTicTacToe() {
  const body = createWindow('Tic-Tac-Toe', '', 400, 500);
  const uniqueId = Date.now();
  body.innerHTML = `
    <div style="text-align:center;padding:15px">
      <div id="tttStatus${uniqueId}" style="font-size:18px;font-weight:600;margin-bottom:15px">Player X's turn</div>
      <div id="tttBoard${uniqueId}" style="display:grid;grid-template-columns:repeat(3,100px);gap:8px;justify-content:center"></div>
      <button class="btn btn-success" style="margin-top:15px" onclick="playTicTacToe()">New Game</button>
    </div>
  `;

  const statusEl = document.getElementById('tttStatus' + uniqueId);
  const boardEl = document.getElementById('tttBoard' + uniqueId);

  let board = Array(9).fill('');
  let currentPlayer = 'X';
  let gameOver = false;

  for (let i = 0; i < 9; i++) {
    const cell = document.createElement('div');
    cell.style.cssText = 'width:100px;height:100px;background:#f8f8f8;border:2px solid #ddd;display:flex;align-items:center;justify-content:center;font-size:48px;cursor:pointer;font-weight:bold;border-radius:8px';
    cell.onclick = () => {
      if (gameOver || board[i]) return;

      board[i] = currentPlayer;
      cell.textContent = currentPlayer;
      cell.style.color = currentPlayer === 'X' ? '#007AFF' : '#FF3B30';

      const winner = checkWinner();
      if (winner) {
        gameOver = true;
        statusEl.textContent = winner === 'TIE' ? "Tie!" : `${winner} wins!`;
        return;
      }

      currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
      statusEl.textContent = `Player ${currentPlayer}'s turn`;
    };
    boardEl.appendChild(cell);
  }

  function checkWinner() {
    const lines = [[0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6]];
    for (const [a,b,c] of lines) {
      if (board[a] && board[a] === board[b] && board[a] === board[c]) {
        return board[a];
      }
    }
    if (board.every(cell => cell)) return 'TIE';
    return null;
  }
}

function playMemory() {
  const body = createWindow('Memory', '', 450, 550);
  const uniqueId = Date.now();
  body.innerHTML = `
    <div style="text-align:center;padding:15px">
      <div id="memoryScore${uniqueId}" style="font-size:18px;font-weight:600;margin-bottom:15px">Moves: 0 | Pairs: 0/8</div>
      <div id="memoryBoard${uniqueId}" style="display:grid;grid-template-columns:repeat(4,90px);gap:10px;justify-content:center"></div>
      <button class="btn btn-success" style="margin-top:15px" onclick="playMemory()">New Game</button>
    </div>
  `;

  const scoreEl = document.getElementById('memoryScore' + uniqueId);
  const boardEl = document.getElementById('memoryBoard' + uniqueId);

  const emojis = ['üçé','üçå','üçí','üçá','üçä','üçã','üçâ','ü•ù'];
  let cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
  let flipped = [];
  let matched = [];
  let moves = 0;

  cards.forEach((emoji, i) => {
    const card = document.createElement('div');
    card.style.cssText = 'width:90px;height:90px;background:#007AFF;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:42px;cursor:pointer;color:#fff';
    card.dataset.index = i;
    card.dataset.emoji = emoji;
    card.textContent = '?';

    card.onclick = () => {
      if (flipped.length === 2 || flipped.includes(i) || matched.includes(i)) return;

      card.textContent = emoji;
      card.style.background = '#f8f8f8';
      card.style.color = '#000';
      flipped.push(i);

      if (flipped.length === 2) {
        moves++;
        scoreEl.textContent = `Moves: ${moves} | Pairs: ${matched.length/2}/8`;

        const [i1, i2] = flipped;
        const card1 = boardEl.children[i1];
        const card2 = boardEl.children[i2];

        if (card1.dataset.emoji === card2.dataset.emoji) {
          matched.push(i1, i2);
          card1.style.background = '#34C759';
          card2.style.background = '#34C759';
          card1.style.color = '#fff';
          card2.style.color = '#fff';
          flipped = [];
          scoreEl.textContent = `Moves: ${moves} | Pairs: ${matched.length/2}/8`;
          if (matched.length === 16) {
            setTimeout(() => showNotification('You Won!', `${moves} moves!`), 500);
          }
        } else {
          setTimeout(() => {
            card1.textContent = '?';
            card2.textContent = '?';
            card1.style.background = '#007AFF';
            card2.style.background = '#007AFF';
            card1.style.color = '#fff';
            card2.style.color = '#fff';
            flipped = [];
          }, 1000);
        }
      }
    };

    boardEl.appendChild(card);
  });
}

// CLOCK
function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit'
  });
}
setInterval(updateClock, 1000);
</script>
</body>
</html>
